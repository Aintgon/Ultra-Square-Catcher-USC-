<!doctype html>
<html>

<head>
  <meta charset='UTF-8'>
  <title>Jeu vidéo de Noé</title>
</head>

<body>
  <canvas width="500" height="500">error</canvas>


  <script>
    //alert("virus detected")

    canvas = document.querySelector("canvas")
    ctx = canvas.getContext("2d")

    //variables
    score = 0
    accelerationMax = 1
    speedLimit = 15
    friction = 0.95
    brake = 0.2
    vitesseEnnemi = 0.5

    ennemi = {
      x: canvas.width/2,
      y: canvas.height/2,
      width: 10,
      height: 10,
    }

    hero = {
      x: 0,
      y: 0,
      width: 25,
      height: 25,
      speed: {
        x: 0,
        y: 0,
      },
      acceleration: {
        x: 0,
        y: 0,
      }

    }

    reward = {
      x: 100,
      y: 100,
      width: 20,
      height: 20,
    }



    function update() {

      //distance

      var distance = Math.sqrt(Math.pow(hero.y - ennemi.y, 2) + Math.pow(hero.x - ennemi.x, 2))

      //ennemi
      var vy = (hero.y - ennemi.y) * vitesseEnnemi / distance
      var vx = (hero.x - ennemi.x) * vitesseEnnemi / distance

      if(score>=10){
      ennemi.y += vy
      ennemi.x += vx
      }

      //acceleration

      hero.speed.x += hero.acceleration.x
      hero.speed.y += hero.acceleration.y
      hero.x += hero.speed.x
      hero.y += hero.speed.y
     

      if (hero.speed.x > speedLimit) {
        hero.speed.x = speedLimit
      }
      if (hero.speed.y > speedLimit) {
        hero.speed.y = speedLimit
      }
      hero.speed.x *= friction
      hero.speed.y *= friction

      //test collision murs

      if (hero.y + hero.height < 0) {
        hero.y = canvas.height
      }
      if (hero.y > canvas.height) {
        hero.y = 0
      }

      if (hero.x + hero.width < 0) {
        hero.x = canvas.width
      }
      if (hero.x > canvas.width) {
        hero.x = 0
      }

      if (collision(reward, hero)) {
        score += 1
        if(score>=10){
        vitesseEnnemi+=0.1}
        reward.x = Math.random() * (canvas.width - reward.width)
        reward.y = Math.random() * (canvas.height - reward.height)
            }
      if(score>=10){
         if(collision(ennemi, hero)){

            score-=Math.round(score/10)
            ennemi.x=canvas.width/2
            ennemi.y=canvas.height/2
            
            if (vitesseEnnemi>0.5){
            vitesseEnnemi=0.5}
          
            hero.x=1
            hero.y=1 }
      }

      draw()
      requestAnimationFrame(update)
    }

    function draw() {

      ctx.clearRect(0, 0, canvas.width, canvas.height)
      ctx.strokeRect(0, 0, canvas.width, canvas.height)
      ctx.fillStyle = 'green'
      ctx.fillRect(hero.x, hero.y, hero.width, hero.height)

      ctx.fillStyle = 'blue'
      ctx.fillRect(reward.x, reward.y, reward.width, reward.height)

      ctx.fillStyle = 'black'
      ctx.fillText("score: " + score, canvas.width / 2, 10)

      if (score>=10){
      ctx.fillStyle = 'red'
      ctx.fillRect(ennemi.x, ennemi.y, ennemi.width, ennemi.height)
      }
    }

    update()

    function collision(r, h) {
      var xin = h.x + h.width >= r.x && h.x <= r.x + r.width,
        yin = h.y + h.height >= r.y && h.y <= r.y + r.height

      return xin && yin
    }

    function keyDown(evt) {
      if (evt.key === "ArrowDown") {
        hero.acceleration.y = accelerationMax
      }
      if (evt.key === "ArrowUp") {
        hero.acceleration.y = -accelerationMax
      }
      if (evt.key === "ArrowRight") {
        hero.acceleration.x = accelerationMax
      }
      if (evt.key === "ArrowLeft") {
        hero.acceleration.x = -accelerationMax
      }
      if (evt.key === "Shift") {
        hero.speed.x *= brake
        hero.speed.y *= brake
      }
    }

    function keyUp(evt) {

      if (evt.key === "ArrowRight" || evt.key === "ArrowLeft") {
        hero.acceleration.x = 0
      }
      if (evt.key === "ArrowUp" || evt.key === "ArrowDown") {
        hero.acceleration.y = 0
      }
    }
    function handleOrientation(event) {
      var beta = event.beta;
      var gamma = event.gamma;
      hero.speed.x = gamma * 0.3
      hero.speed.y = beta * 0.3
    }
    window.ondeviceorientation = handleOrientation
    window.onkeyup = keyUp
    window.onkeydown = keyDown
  </script>
</body>

</html>